{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <title>Mis Pedidos - Tres En Uno</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <link href="{% static 'img/logo.jpg' %}" rel="icon">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    
    <style>
        .pedido-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .pedido-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .pedido-numero {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
        }
        
        .estado-badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .estado-pendiente_pago {
            background: #fff3cd;
            color: #856404;
        }
        
        .estado-pagado {
            background: #d4edda;
            color: #155724;
        }
        
        .estado-preparando {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .estado-enviado {
            background: #cce5ff;
            color: #004085;
        }
        
        .estado-completado {
            background: #d6d8db;
            color: #383d41;
        }
        
        .estado-cancelado {
            background: #f8d7da;
            color: #721c24;
        }
        
        .pedido-detalles {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .pedido-info {
            flex: 1;
            min-width: 250px;
        }
        
        .pedido-info p {
            margin-bottom: 8px;
            color: #666;
        }
        
        .pedido-total {
            font-size: 1.8rem;
            font-weight: bold;
            color: #28a745;
        }
        
        .pedido-acciones {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }
        
        .vacio-container {
            text-align: center;
            padding: 80px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .vacio-container i {
            font-size: 80px;
            color: #ddd;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    {% include 'miapp/barrabase.html' %}

    <div class="container-fluid page-header">
        <div class="container">
            <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 300px">
                <h3 class="display-4 text-white text-uppercase">Mis Pedidos</h3>
                <div class="d-inline-flex text-white">
                    <p class="m-0 text-uppercase"><a class="text-white" href="{% url 'inicio' %}">Inicio</a></p>
                    <i class="fa fa-angle-double-right pt-1 px-3"></i>
                    <p class="m-0 text-uppercase">Mis Pedidos</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid py-5">
        <div class="container">
            {% if pedidos %}
                <div class="mb-4">
                    <h4>Tienes {{ pedidos|length }} pedido{% if pedidos|length > 1 %}s{% endif %}</h4>
                    <p class="text-muted">Aquí puedes ver el estado de todos tus pedidos</p>
                </div>

                {% for pedido in pedidos %}
                <div class="pedido-card">
                    <div class="pedido-header">
                        <div>
                            <span class="pedido-numero">Pedido #{{ pedido.id }}</span>
                            <p class="text-muted mb-0">
                                <i class="fa fa-calendar mr-2"></i>{{ pedido.fecha_pedido|date:"d/m/Y H:i" }}
                            </p>
                        </div>
                        <span class="estado-badge estado-{{ pedido.estado_pedido }}">
                            {{ pedido.get_estado_pedido_display }}
                        </span>
                    </div>

                    <div class="pedido-detalles">
                        <div class="pedido-info">
                            <p>
                                <i class="fa fa-box mr-2"></i>
                                <strong>Productos:</strong> 
                                {{ pedido.detallepedido_set.count }} item{% if pedido.detallepedido_set.count > 1 %}s{% endif %}
                            </p>
                            <p>
                                <i class="fa fa-credit-card mr-2"></i>
                                <strong>Método de pago:</strong> 
                                {{ pedido.get_metodo_pago_display }}
                            </p>
                            <p>
                                <i class="fa fa-map-marker-alt mr-2"></i>
                                <strong>Envío a:</strong> 
                                {{ pedido.comuna }}, {{ pedido.region }}
                            </p>
                            
                            {% if pedido.numero_seguimiento %}
                            <p>
                                <i class="fa fa-truck mr-2"></i>
                                <strong>Nº Seguimiento:</strong> 
                                <span class="badge badge-info">{{ pedido.numero_seguimiento }}</span>
                            </p>
                            {% endif %}
                        </div>
                        
                        <div class="text-right">
                            <p class="text-muted mb-1">Total</p>
                            <div class="pedido-total">${{ pedido.total_pedido|floatformat:0 }}</div>
                        </div>
                    </div>

                    <div class="pedido-acciones">
                        <a href="/pedido-confirmado/{{ pedido.id }}/" class="btn btn-primary">
                            <i class="fa fa-eye mr-2"></i>Ver Detalle
                        </a>
                        
                        {% if pedido.estado_pedido == 'pendiente_pago' %}
                        <button class="btn btn-success" onclick="mostrarDatosPago('{{ pedido.id }}', '{{ pedido.total_pedido }}')">
                            <i class="fa fa-university mr-2"></i>Ver Datos de Pago
                        </button>
                        {% endif %}
                        
                        <a href="mailto:ventas.tresenuno@gmail.com?subject=Consulta%20sobre%20Pedido%20{{ pedido.id }}" class="btn btn-outline-secondary">
                            <i class="fa fa-envelope mr-2"></i>Contactar Soporte
                        </a>
                    </div>
                </div>
                {% endfor %}

            {% else %}
                <div class="vacio-container">
                    <i class="fa fa-shopping-bag"></i>
                    <h3>No tienes pedidos aún</h3>
                    <p class="text-muted mb-4">¡Es hora de hacer tu primera compra!</p>
                    <a href="{% url 'listar_productos' %}" class="btn btn-primary btn-lg">
                        <i class="fa fa-shopping-cart mr-2"></i>Ver Productos
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="modal fade" id="modalDatosPago" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">
                        <i class="fa fa-university mr-2"></i>Datos para Transferencia
                    </h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Pedido #<span id="modal-pedido-id"></span></strong>
                    </div>
                    
                    <table class="table table-bordered">
                        <tr>
                            <td><strong>Banco:</strong></td>
                            <td>Banco Estado</td>
                        </tr>
                        <tr>
                            <td><strong>Tipo de Cuenta:</strong></td>
                            <td>Cuenta Corriente</td>
                        </tr>
                        <tr>
                            <td><strong>Número de Cuenta:</strong></td>
                            <td>123456789</td>
                        </tr>
                        <tr>
                            <td><strong>RUT:</strong></td>
                            <td>12.345.678-9</td>
                        </tr>
                        <tr>
                            <td><strong>Titular:</strong></td>
                            <td>Tres En Uno SpA</td>
                        </tr>
                        <tr class="table-warning">
                            <td><strong>Monto a Transferir:</strong></td>
                            <td><strong>$<span id="modal-monto"></span></strong></td>
                        </tr>
                    </table>
                    
                    <div class="alert alert-warning mb-0">
                        <i class="fa fa-exclamation-triangle mr-2"></i>
                        <strong>Importante:</strong> Incluye el número de pedido en el mensaje de la transferencia.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    {% include 'miapp/barrabaja.html' %}

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'lib/easing/easing.min.js' %}"></script>
    <script src="{% static 'lib/owlcarousel/owl.carousel.min.js' %}"></script>
    <script src="{% static 'lib/waypoints/waypoints.min.js' %}"></script>
    <script src="{% static 'lib/counterup/counterup.min.js' %}"></script>
    <script src="{% static 'mail/jqBootstrapValidation.min.js' %}"></script>
    <script src="{% static 'mail/contact.js' %}"></script>
    <script src="{% static 'js/main.js' %}"></script>

    <script>
        function mostrarDatosPago(pedidoId, monto) {
            document.getElementById('modal-pedido-id').textContent = pedidoId;
            document.getElementById('modal-monto').textContent = parseInt(monto).toLocaleString('es-CL');
            $('#modalDatosPago').modal('show');
        }
    </script>
</body>

</html>